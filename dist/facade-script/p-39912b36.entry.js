import{r as t,c as s,h as r,e,g as i}from"./p-2559a26d.js";const o={1:"Script triggered but missing src"},n={IDLE:0,TRIGGERED_BUT_NO_SRC:.1,TRIGGERED:2,WAITING:3,LOADING:4,LOADED:5,READY:6,TIMEOUT:7},c={};for(const p in n)c[n[p]]=p;const a={},h=class{constructor(r){t(this,r),this.pengscript=s(this,"pengscript",7),this.isOnce=!1,this.isGlobal=!1,this.trigger="lazy",this.wait=0,this.showWhen="LOADED",this.statusMsg="IDLE",this.status=0,this.onTrigger=()=>{const{isOnce:t,isGlobal:s,isIframe:r,wait:e,src:i,props:o,onLoad:c,timeout:h}=this;if(this.status=n.TRIGGERED,!i)return this.error=1,void(this.status=n.IDLE);if(this.error&&(this.error=void 0),t&&u(i))return l(i)<n.LOADING&&(a[i]=n.LOADING),void(this.status=l(i));const p=()=>{!s||t&&u(i)||function(t,s={},r){const e=document.createElement(t);Object.keys(s).forEach((t=>{let r=s[t];e.hasOwnProperty(t)||"function"==typeof r||(r="object"==typeof r&&function(t){try{return JSON.stringify(t)}catch(s){return}}(r)||r)?e[t]=r:e.setAttribute(t,r)})),r&&r.appendChild(e)}(r?"iframe":"script",Object.assign({src:i,onLoad:c},d(o)),document.head),this.status=a[i]=n.LOADING,h&&(this.timeoutId=setTimeout((()=>{this.status<n.READY&&(this.status=n.TIMEOUT)}),h))};e?(this.status=n.WAITING,setTimeout(p,e)):p()},this.onLoad=()=>{if(this.status!==n.TIMEOUT){const{src:t,isOnce:s,isReady:r,timeout:e,timeoutId:i}=this;clearTimeout(i),s&&(a[t]=n.LOADED),this.status=n.LOADED,async function(t,s,r=200){return new Promise(((e,i)=>{let o;const n=setInterval((()=>{t()&&(clearTimeout(o),clearInterval(n),e())}),parseInt(r)||200);s&&(o=setTimeout((()=>{clearInterval(n),i("timeout")}),parseInt(s)||3e4))}))}(r||(()=>!0),e).then((()=>this.status=n.READY)).catch((t=>console.error("awaitScriptReady",t)))}}}onError(t){this.errorMsg=o[t]}onStatus(t,s){if(t===s)return;const{error:r,errorMsg:e,isOnce:i,src:o,timeoutId:h,host:u}=this;h&&t>=n.READY&&clearTimeout(h),i&&t>=n.LOADING&&t>l(o)&&(a[o]=t);const d={status:c[t],code:t,error:r,errorMsg:e,id:u.id,src:o};this.statusMsg=c[t],this.pengscript.emit(d)}componentWillLoad(){this.src=this.srcProd}componentDidLoad(){const{trigger:t,isOnce:s,onTrigger:r,src:e,host:i}=this;let o;switch(!0){case"now"===t:o=r;break;case"lazy"===t:o=()=>{return(t=r,new IntersectionObserver((([s],r)=>{s.isIntersecting&&(r.disconnect(),t())}))).observe(i);var t};break;case"function"==typeof t:o=t}o&&o(r),s&&u(e)&&(l(e)<n.LOADING&&(a[e]=n.LOADING),this.status=l(e))}render(){const{isIframe:t,src:s,isGlobal:i,props:o,trigger:c,onLoad:a,showWhen:h,status:l,statusMsg:p,isOnce:f}=this;let m;const O=n[String(h).toUpperCase()]||n.LOADED;if(!i&&l>n.WAITING&&(!f||!u(s))){const e=t?"iframe":"script",i=Object.assign({src:s,onLoad:a},d(o));m=r(e,Object.assign({},i))}const g=l>=O&&l!==n.TIMEOUT;return r(e,Object.assign({},{onClick:"click"===c&&this.onTrigger}),r("div",{"data-script-status":p,class:"facade-placeholder-content",hidden:g},r("slot",null)),r("div",{"data-script-status":p,class:"facade-scripted-content",hidden:!g},m))}get host(){return i(this)}static get watchers(){return{error:["onError"],status:["onStatus"]}}};function u(t){return l(t)>=n.TRIGGERED||Boolean(document.querySelector(`script[src^="${t}"]`))}function d(t){try{return("object"==typeof t?t:t&&JSON.parse(t))||{}}catch(s){return void console.error("Error parsing props JSON",s,"JSON:",t)}}function l(t){return a[t]||n.IDLE}export{h as facade_script}