import{r as t,c as s,h as i,e as r,g as e}from"./p-2559a26d.js";const o={1:"Script triggered but missing src"},c={IDLE:0,TRIGGERED_BUT_NO_SRC:.1,TRIGGERED:2,WAITING:3,LOADING:4,LOADED:5,READY:6,TIMEOUT:7},n={};for(const p in c)n[c[p]]=p;const a={};let h=0;const d=class{constructor(i){t(this,i),this.pengscript=s(this,"pengscript",7),this.once=!1,this.global=!1,this.trigger="lazy",this.wait=0,this.showWhen="LOADED",this.statusMsg="IDLE",this.status=0,this.uid=h++,this.isScriptOnPage=()=>{const{src:t,uid:s}=this;return Boolean(document.querySelector(`script[src^="${t}"]:not([data-facadescriptid="${s}"]),iframe[src^="${t}"]:not([data-facadescriptid="${s}"])`))},this.onTrigger=()=>{const{once:t,global:s,iframe:i,wait:r,src:e,uid:o,props:n,onLoad:h,timeout:d}=this;if(this.status=c.TRIGGERED,!e)return this.error=1,void(this.status=c.IDLE);if(this.error&&(this.error=void 0),t&&this.isScriptOnPage())return l(e)<c.LOADING&&(a[e]=c.LOADING),void(this.status=l(e));const p=()=>{t&&this.isScriptOnPage()?this.status=a[e]||(a[e]=c.READY):(!s||t&&this.isScriptOnPage()||function(t,s={},i){const r=document.createElement(t);function e(t){try{return JSON.stringify(t)}catch(s){return}}Object.keys(s).forEach((t=>{let i=s[t];r.hasOwnProperty(t)||"function"==typeof i||"object"==typeof i&&e(i)&&(i=e(i))?r[t]=i:r.setAttribute(t,i)})),i&&i.appendChild(r)}(i?"iframe":"script",Object.assign({src:e,"data-facadescriptid":o,onLoad:h},u(n)),document.head),this.status=a[e]=c.LOADING,d&&(this.timeoutId=setTimeout((()=>{this.status<c.READY&&(this.status=c.TIMEOUT)}),d)))};r?(this.status=c.WAITING,setTimeout(p,r)):p()},this.onLoad=()=>{if(this.status!==c.TIMEOUT){const{src:t,once:s,isReady:i,timeout:r,timeoutId:e}=this;clearTimeout(e),s&&(a[t]=c.LOADED),this.status=c.LOADED,async function(t,s,i=200){return new Promise(((r,e)=>{let o;const c=setInterval((()=>{t()&&(clearTimeout(o),clearInterval(c),r())}),parseInt(i)||200);s&&(o=setTimeout((()=>{clearInterval(c),e("timeout")}),parseInt(s)||3e4))}))}(i||(()=>!0),r).then((()=>this.status=c.READY)).catch((t=>console.error("awaitScriptReady",t)))}}}onError(t){this.errorMsg=o[t]}onStatus(t,s){if(t===s)return;const{debug:i,error:r,errorMsg:e,once:o,src:h,timeoutId:d,host:u}=this;d&&t>=c.READY&&clearTimeout(d),o&&t>=c.LOADING&&t>l(h)&&(a[h]=t);const p={code:t,status:n[t],error:r,errorMsg:e,id:u.id,src:h};if(this.statusMsg=n[t],this.pengscript.emit(p),i){const{uid:t,iframe:s,global:i}=this;console.debug("pengscript:",Object.assign(Object.assign({},p),{uid:t,iframe:s,once:o,global:i}))}}componentWillLoad(){this.src=this.srcProd}componentDidLoad(){const{trigger:t,once:s,onTrigger:i,src:r,host:e}=this;let o;switch(!0){case"now"===t:o=i;break;case"lazy"===t:o=()=>{return(t=i,new IntersectionObserver((([s],i)=>{s.isIntersecting&&(i.disconnect(),t())}))).observe(e);var t};break;case"function"==typeof t:o=t}o&&o(i),s&&this.isScriptOnPage()&&(l(r)<c.LOADING&&(a[r]=c.LOADING),this.status=l(r))}render(){const{iframe:t,src:s,uid:e,global:o,props:n,trigger:a,onLoad:h,showWhen:d,status:l,once:p}=this;let f;const m=l<(c[String(d).toUpperCase()]||c.LOADED);if(!o&&l>c.WAITING&&(!p||!this.isScriptOnPage())){const r=t?"iframe":"script",o=Object.assign({src:s,onLoad:h,hidden:m,"data-facadescriptid":e},u(n));f=i(r,Object.assign({},o))}const g=!m&&l!==c.TIMEOUT;return i(r,Object.assign({},{onClick:"click"===a&&this.onTrigger}),i("div",{class:"facade-script-placeholder",hidden:g},i("slot",null)),f)}get host(){return e(this)}static get watchers(){return{error:["onError"],status:["onStatus"]}}};function u(t){try{return("object"==typeof t?t:t&&JSON.parse(t))||{}}catch(s){return void console.error("Error parsing props JSON",s,"JSON:",t)}}function l(t){return a[t]||c.IDLE}export{d as facade_script}