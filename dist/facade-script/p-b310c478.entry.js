import{r as t,c as s,h as e,e as r,g as i}from"./p-1b582e84.js";const o={1:"Script triggered but missing src"},c={IDLE:0,TRIGGERED_BUT_NO_SRC:.1,TRIGGERED:2,WAITING:3,LOADING:4,LOADED:5,READY:6,TIMEOUT:7},n={};for(const p in c)n[c[p]]=p;const a={},h=class{constructor(e){t(this,e),this.pengscript=s(this,"pengscript",7),this.isOnce=!1,this.isGlobal=!1,this.trigger="lazy",this.wait=0,this.showWhen="LOADED",this.statusMessage=n[c.IDLE],this.status=0,this.onTrigger=()=>{const{isGlobal:t,isIframe:s,wait:e,src:r,props:i,onLoad:o,timeout:n}=this;if(this.status=c.TRIGGERED,!r)return this.error=1,void(this.status=c.IDLE);if(this.error&&(this.error=void 0),this.isOnce&&u(r))return l(r)<c.LOADING&&(a[r]=c.LOADING),void(this.status=l(r));const h=()=>{!t||this.isOnce&&u(r)||function(t,s={},e){const r=document.createElement(t);Object.keys(s).forEach(t=>{let e=s[t];r.hasOwnProperty(t)||"function"==typeof e||(e="object"==typeof e&&function(t){try{return JSON.stringify(t)}catch(s){return}}(e)||e)?r[t]=e:r.setAttribute(t,e)}),e&&e.appendChild(r)}(s?"iframe":"script",Object.assign({src:r,onload:o},d(i)),document.head),this.status=a[r]=c.LOADING,n&&(this.timeoutId=setTimeout(()=>{this.status<c.READY&&(this.status=c.TIMEOUT)},n))};e?(this.status=c.WAITING,setTimeout(h,e)):h()},this.onLoad=()=>{if(this.status!==c.TIMEOUT){const{src:t,isOnce:s,isReady:e,timeout:r,timeoutId:i}=this;clearTimeout(i),s&&(a[t]=c.LOADED),this.status=c.LOADED,async function(t,s,e=200){return new Promise((r,i)=>{let o;const c=setInterval(()=>{t()&&(clearTimeout(o),clearInterval(c),r())},parseInt(e)||200);parseInt(s)&&(o=setTimeout(()=>{clearInterval(c),i("timeout")},parseInt(s)))})}(e||(()=>!0),r).then(()=>this.status=c.READY).catch(t=>console.error("awaitScriptReady",t))}}}onError(t){this.errorMessage=o[t]}onStatus(t,s){if(t===s)return;const{wait:e,error:r,errorMessage:i,isOnce:o,src:h,timeoutId:u,host:d}=this;console.info("PengScript:",JSON.stringify({code:t,status:n[t],wait:e,timeoutId:u,src:h})),u&&t>=c.READY&&clearTimeout(u),o&&t>=c.LOADING&&t>l(h)&&(a[h]=t);const p={status:n[t],code:t,error:r,errorMessage:i,id:d.id,src:h};this.statusMessage=n[t],this.pengscript.emit(p)}componentWillLoad(){this.src=this.srcProd}componentDidLoad(){const{trigger:t,onTrigger:s,src:e,host:r}=this;let i;switch(!0){case"now"===t:i=s;break;case"lazy"===t:i=()=>{return(t=s,new IntersectionObserver(([s],e)=>{s.isIntersecting&&(e.disconnect(),t())})).observe(r);var t};break;case"function"==typeof t:i=t}i&&i(s),this.isOnce&&u(e)&&(l(e)<c.LOADING&&(a[e]=c.LOADING),this.status=l(e))}render(){const{isIframe:t,src:s,isGlobal:i,props:o,trigger:n,onLoad:a,showWhen:h,status:l,statusMessage:p,isOnce:f}=this;let m;const g=c[String(h).toUpperCase()]||c.LOADED;if(!i&&l>c.WAITING&&(!f||!u(s))){const r=t?"iframe":"script",i=Object.assign({src:s,onLoad:a},d(o));m=e(r,Object.assign({},i))}const I=l>=g&&l!==c.TIMEOUT;return e(r,Object.assign({},{onClick:"click"===n&&this.onTrigger}),e("div",{"data-script-status":p,class:"facade-placeholder-content",hidden:I},e("slot",null)),e("div",{"data-script-status":p,class:"facade-scripted-content",hidden:!I},m))}get host(){return i(this)}static get watchers(){return{error:["onError"],status:["onStatus"]}}};function u(t){return l(t)>=c.TRIGGERED||Boolean(document.querySelector(`script[src^="${t}"]`))}function d(t){try{return("object"==typeof t?t:t&&JSON.parse(t))||{}}catch(s){return void console.error("Error parsing props JSON",s,"JSON:",t)}}function l(t){return a[t]||c.IDLE}export{h as facade_script}