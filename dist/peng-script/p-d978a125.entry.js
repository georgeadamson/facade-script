import{r as t,c as s,h as e,H as r,g as i}from"./p-0244110a.js";const o={1:"Script triggered but missing src"},n={IDLE:0,TRIGGERED_BUT_NO_SRC:.1,TRIGGERED:2,WAITING:3,LOADING:4,LOADED:5,READY:6,TIMEOUT:7},c={};for(const t in n)c[n[t]]=t;const a={},h=class{constructor(e){t(this,e),this.pengscript=s(this,"pengscript",7),this.isOnce=!1,this.isGlobal=!1,this.trigger="lazy",this.wait=0,this.showWhen="LOADED",this.statusMessage=c[n.IDLE],this.status=0,this.onTrigger=()=>{const{isGlobal:t,isIframe:s,wait:e,src:r,props:i,onLoad:o,timeout:c}=this;if(this.status=n.TRIGGERED,!r)return this.error=1,void(this.status=n.IDLE);if(this.error&&(this.error=void 0),this.isOnce&&u(r))return p(r)<n.LOADING&&(a[r]=n.LOADING),void(this.status=p(r));const h=()=>{!t||this.isOnce&&u(r)||function(t,s={},e){const r=document.createElement(t);Object.keys(s).forEach(t=>{let e=s[t];r.hasOwnProperty(t)||"function"==typeof e||(e="object"==typeof e&&function(t){try{return JSON.stringify(t)}catch(t){return}}(e)||e)?r[t]=e:r.setAttribute(t,e)}),e&&e.appendChild(r)}(s?"iframe":"script",Object.assign({src:r,onload:o},l(i)),document.head),this.status=a[r]=n.LOADING,c&&(this.timeoutId=setTimeout(()=>{this.status<n.READY&&(this.status=n.TIMEOUT)},c))};e?(this.status=n.WAITING,setTimeout(h,e)):h()},this.onLoad=()=>{if(this.status!==n.TIMEOUT){const{src:t,isOnce:s,isReady:e,timeout:r,timeoutId:i}=this;clearTimeout(i),s&&(a[t]=n.LOADED),this.status=n.LOADED,async function(t,s,e=200){return new Promise((r,i)=>{let o;const n=setInterval(()=>{t()&&(clearTimeout(o),clearInterval(n),r())},parseInt(e)||200);parseInt(s)&&(o=setTimeout(()=>{clearInterval(n),i("timeout")},parseInt(s)))})}(e||(()=>!0),r).then(()=>this.status=n.READY).catch(t=>console.error("awaitScriptReady",t))}}}onError(t){this.errorMessage=o[t]}onStatus(t,s){if(t===s)return;const{wait:e,error:r,errorMessage:i,isOnce:o,src:h,timeoutId:u,host:l}=this;console.info("PengScript:",JSON.stringify({code:t,status:c[t],wait:e,timeoutId:u,src:h})),u&&t>=n.READY&&clearTimeout(u),o&&t>=n.LOADING&&t>p(h)&&(a[h]=t);const d={status:c[t],code:t,error:r,errorMessage:i,id:l.id,src:h};this.statusMessage=c[t],this.pengscript.emit(d)}componentWillLoad(){this.src=this.srcProd}componentDidLoad(){const{trigger:t,onTrigger:s,src:e,host:r}=this;let i;switch(!0){case"now"===t:i=s;break;case"lazy"===t:i=()=>{return(t=s,new IntersectionObserver(([s],e)=>{s.isIntersecting&&(e.disconnect(),t())})).observe(r);var t};break;case"function"==typeof t:i=t}i&&i(s),this.isOnce&&u(e)&&(p(e)<n.LOADING&&(a[e]=n.LOADING),this.status=p(e))}render(){const{isIframe:t,src:s,isGlobal:i,props:o,trigger:c,onLoad:a,showWhen:h,status:p,statusMessage:d,isOnce:m}=this;let f;const g=n[String(h).toUpperCase()]||n.LOADED;if(!i&&p>n.WAITING&&(!m||!u(s))){const r=t?"iframe":"script",i=Object.assign({src:s,onLoad:a},l(o));f=e(r,Object.assign({},i))}const I=p>=g&&p!==n.TIMEOUT;return e(r,Object.assign({},{onClick:"click"===c&&this.onTrigger}),e("div",{"data-script-status":d,class:"peng-placeholder-content",hidden:I},e("slot",null)),e("div",{"data-script-status":d,class:"peng-scripted-content",hidden:!I},f))}get host(){return i(this)}static get watchers(){return{error:["onError"],status:["onStatus"]}}};function u(t){return p(t)>=n.TRIGGERED||Boolean(document.querySelector(`script[src^="${t}"]`))}function l(t){try{return("object"==typeof t?t:t&&JSON.parse(t))||{}}catch(s){return void console.error("Error parsing props JSON",s,"JSON:",t)}}function p(t){return a[t]||n.IDLE}export{h as peng_script}