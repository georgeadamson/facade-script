var __awaiter=this&&this.__awaiter||function(t,e,r,n){function i(t){return t instanceof r?t:new r((function(e){e(t)}))}return new(r||(r=Promise))((function(r,a){function o(t){try{c(n.next(t))}catch(e){a(e)}}function s(t){try{c(n["throw"](t))}catch(e){a(e)}}function c(t){t.done?r(t.value):i(t.value).then(o,s)}c((n=n.apply(t,e||[])).next())}))};var __generator=this&&this.__generator||function(t,e){var r={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},n,i,a,o;return o={next:s(0),throw:s(1),return:s(2)},typeof Symbol==="function"&&(o[Symbol.iterator]=function(){return this}),o;function s(t){return function(e){return c([t,e])}}function c(o){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,i&&(a=o[0]&2?i["return"]:o[0]?i["throw"]||((a=i["return"])&&a.call(i),0):i.next)&&!(a=a.call(i,o[1])).done)return a;if(i=0,a)o=[o[0]&2,a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:r.label++;return{value:o[1],done:false};case 5:r.label++;i=o[1];o=[0];continue;case 7:o=r.ops.pop();r.trys.pop();continue;default:if(!(a=r.trys,a=a.length>0&&a[a.length-1])&&(o[0]===6||o[0]===2)){r=0;continue}if(o[0]===3&&(!a||o[1]>a[0]&&o[1]<a[3])){r.label=o[1];break}if(o[0]===6&&r.label<a[1]){r.label=a[1];a=o;break}if(a&&r.label<a[2]){r.label=a[2];r.ops.push(o);break}if(a[2])r.ops.pop();r.trys.pop();continue}o=e.call(t,r)}catch(s){o=[6,s];i=0}finally{n=a=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true}}};import{r as registerInstance,c as createEvent,h,e as Host,g as getElement}from"./index-d373a0aa.js";var ERROR_MESSAGE={1:"Script triggered but missing src"};var STATUS={IDLE:0,TRIGGERED_BUT_NO_SRC:.1,TRIGGERED:2,WAITING:3,LOADING:4,LOADED:5,READY:6,TIMEOUT:7};var STATUS_NAME={};for(var key in STATUS)STATUS_NAME[STATUS[key]]=key;var globalStatusCode={};var nextUid=0;var FacadeScript=function(){function t(t){var e=this;registerInstance(this,t);this.pengscript=createEvent(this,"pengscript",7);this.once=false;this.global=false;this.trigger="lazy";this.wait=0;this.showWhen="LOADED";this.statusMsg="IDLE";this.status=0;this.uid=nextUid++;this.isScriptOnPage=function(){var t=e,r=t.src,n=t.uid;var i='script[src^="'+r+'"]:not([data-facadescriptid="'+n+'"])';var a='iframe[src^="'+r+'"]:not([data-facadescriptid="'+n+'"])';return Boolean(document.querySelector(i+","+a))};this.onTrigger=function(){var t=e,r=t.once,n=t.global,i=t.iframe,a=t.wait,o=t.src,s=t.uid,c=t.props,u=t.onLoad,f=t.timeout;e.status=STATUS.TRIGGERED;if(!o){e.error=1;e.status=STATUS.IDLE;return}else if(e.error){e.error=undefined}if(r&&e.isScriptOnPage()){if(statusOfGlobalScript(o)<STATUS.LOADING){globalStatusCode[o]=STATUS.LOADING}e.status=statusOfGlobalScript(o);return}var l=function(){if(r&&e.isScriptOnPage()){e.status=globalStatusCode[o]||(globalStatusCode[o]=STATUS.READY);return}if(n&&!(r&&e.isScriptOnPage())){createElement(i?"iframe":"script",Object.assign({src:o,"data-facadescriptid":s,onLoad:u},parseJSON(c)),document.head)}e.status=globalStatusCode[o]=STATUS.LOADING;if(f){e.timeoutId=setTimeout((function(){if(e.status<STATUS.READY){e.status=STATUS.TIMEOUT}}),f)}};if(a){e.status=STATUS.WAITING;setTimeout(l,a)}else{l()}};this.onLoad=function(){if(e.status!==STATUS.TIMEOUT){var t=e,r=t.src,n=t.once,i=t.isReady,a=t.timeout,o=t.timeoutId;clearTimeout(o);if(n)globalStatusCode[r]=STATUS.LOADED;e.status=STATUS.LOADED;awaitScriptReady(i||function(){return true},a).then((function(){return e.status=STATUS.READY})).catch((function(t){return console.error("awaitScriptReady",t)}))}}}t.prototype.onError=function(t){this.errorMsg=ERROR_MESSAGE[t]};t.prototype.onStatus=function(t,e){if(t===e)return;var r=this,n=r.debug,i=r.error,a=r.errorMsg,o=r.once,s=r.src,c=r.timeoutId,u=r.host;if(c&&t>=STATUS.READY){clearTimeout(c)}if(o&&t>=STATUS.LOADING&&t>statusOfGlobalScript(s)){globalStatusCode[s]=t}var f={code:t,status:STATUS_NAME[t],error:i,errorMsg:a,id:u.id,src:s};this.statusMsg=STATUS_NAME[t];this.pengscript.emit(f);if(n){var l=this,S=l.uid,p=l.iframe,d=l.global;console.debug("pengscript:",Object.assign(Object.assign({},f),{uid:S,iframe:p,once:o,global:d}))}};t.prototype.componentWillLoad=function(){this.src=this.srcProd};t.prototype.componentDidLoad=function(){var t=this,e=t.trigger,r=t.once,n=t.onTrigger,i=t.src,a=t.host;var o;switch(true){case e==="now":{o=n;break}case e==="lazy":{o=function(){return newIntersectionObserver(n).observe(a)};break}case typeof e==="function":{o=e;break}}if(o){o(n)}if(r&&this.isScriptOnPage()){if(statusOfGlobalScript(i)<STATUS.LOADING){globalStatusCode[i]=STATUS.LOADING}this.status=statusOfGlobalScript(i)}};t.prototype.render=function(){var t=this,e=t.iframe,r=t.src,n=t.uid,i=t.global,a=t.props,o=t.trigger,s=t.onLoad,c=t.showWhen,u=t.status,f=t.once;var l;var S=STATUS[String(c).toUpperCase()]||STATUS.LOADED;var p=u<S;if(!i&&u>STATUS.WAITING&&!(f&&this.isScriptOnPage())){var d=e?"iframe":"script";var T=Object.assign({src:r,onLoad:s,hidden:p,"data-facadescriptid":n},parseJSON(a));l=h(d,Object.assign({},T))}var g={onClick:o==="click"&&this.onTrigger};var b=!p&&u!==STATUS.TIMEOUT;return h(Host,Object.assign({},g),h("div",{class:"facade-script-placeholder",hidden:b},h("slot",null)),l)};Object.defineProperty(t.prototype,"host",{get:function(){return getElement(this)},enumerable:false,configurable:true});Object.defineProperty(t,"watchers",{get:function(){return{error:["onError"],status:["onStatus"]}},enumerable:false,configurable:true});return t}();function parseJSON(t){try{return(typeof t==="object"?t:t&&JSON.parse(t))||{}}catch(e){console.error("Error parsing props JSON",e,"JSON:",t);return undefined}}function createElement(t,e,r){if(e===void 0){e={}}var n=document.createElement(t);Object.keys(e).forEach((function(t){var r=e[t];n.hasOwnProperty(t)||typeof r==="function"||typeof r==="object"&&i(r)&&(r=i(r))?n[t]=r:n.setAttribute(t,r)}));if(r)r.appendChild(n);function i(t){try{return JSON.stringify(t)}catch(e){return undefined}}}function statusOfGlobalScript(t){return globalStatusCode[t]||STATUS.IDLE}function newIntersectionObserver(t){return new IntersectionObserver((function(e,r){var n=e[0];if(n.isIntersecting){r.disconnect();t()}}))}function awaitScriptReady(t,e,r){if(r===void 0){r=200}return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){return[2,new Promise((function(n,i){var a;var o=setInterval((function(){if(t()){clearTimeout(a);clearInterval(o);n()}}),parseInt(r)||200);if(e){a=setTimeout((function(){clearInterval(o);i("timeout")}),parseInt(e)||3e4)}}))]}))}))}export{FacadeScript as facade_script};